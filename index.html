<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youth Revival Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div id="app"></div>

    <script>
        // CONFIGURATION: Add your webcal URLs here
        const WEBCAL_URL = 'https://r.elvanto.eu/fullcalendar/753273ae-219b-4007-b86f-e794397cbbde/60a53343-8476-4ccd-8b1b-729f8ce7c5b8.ics';
        const TEAM_WEBCAL_URL = 'https://r.elvanto.eu/fullcalendar/7b489ca4-e465-4eb4-b6cd-492ad1178b12/acaf434d-c2c0-41da-8403-73b1e3fabf92.ics';
        
        const months = [
            'JANUAR', 'FEBRUAR', 'MÄRZ', 'APRIL', 'MAI', 'JUNI',
            'JULI', 'AUGUST', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DEZEMBER'
        ];

        let year = 2026;
        let events = [];
        let teamEvents = [];
        let includeTeam = false;
        let lastUpdated = null;
        let isLoading = false;
        let teamUnlocked = false;
        const TEAM_PASSWORD = 'lordsendrevival';

        // Auto-refresh every 30 minutes
        setInterval(() => {
            console.log('Auto-refreshing calendar...');
            fetchWebcal();
        }, 30 * 60 * 1000);

        function formatLastUpdated() {
            if (!lastUpdated) return '';
            return lastUpdated.toLocaleString('de-CH', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function parseICalDate(dateStr, tzid = null) {
            if (!dateStr) return null;
            
            if (dateStr.length === 8) {
                const y = parseInt(dateStr.substring(0, 4));
                const m = parseInt(dateStr.substring(4, 6)) - 1;
                const d = parseInt(dateStr.substring(6, 8));
                const date = new Date(y, m, d, 0, 0, 0);
                date.isAllDay = true;
                return date;
            }
            
            if (dateStr.includes('T')) {
                const isUTC = dateStr.endsWith('Z');
                const cleanDate = dateStr.replace('Z', '');
                const y = parseInt(cleanDate.substring(0, 4));
                const m = parseInt(cleanDate.substring(4, 6)) - 1;
                const d = parseInt(cleanDate.substring(6, 8));
                const h = parseInt(cleanDate.substring(9, 11)) || 0;
                const min = parseInt(cleanDate.substring(11, 13)) || 0;
                const s = parseInt(cleanDate.substring(13, 15)) || 0;
                
                if (isUTC) {
                    const utcDate = new Date(Date.UTC(y, m, d, h, min, s));
                    const zurichDate = new Date(utcDate.toLocaleString('en-US', { timeZone: 'Europe/Zurich' }));
                    return zurichDate;
                } else {
                    return new Date(y, m, d, h, min, s);
                }
            }
            
            return new Date(dateStr);
        }

        function parseICalendar(icalData) {
            const events = [];
            const lines = icalData.split(/\r?\n/);
            let currentEvent = null;
            let calendarTzid = 'Europe/Zurich';

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                while (i + 1 < lines.length && (lines[i + 1].startsWith(' ') || lines[i + 1].startsWith('\t'))) {
                    i++;
                    line += lines[i].substring(1);
                }

                if (line.startsWith('X-WR-TIMEZONE:')) {
                    calendarTzid = line.substring(14);
                }

                if (line === 'BEGIN:VEVENT') {
                    currentEvent = { isAllDay: false };
                } else if (line === 'END:VEVENT' && currentEvent) {
                    events.push(currentEvent);
                    currentEvent = null;
                } else if (currentEvent) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const keyPart = line.substring(0, colonIndex);
                        const value = line.substring(colonIndex + 1);
                        
                        let tzid = null;
                        if (keyPart.includes('TZID=')) {
                            const tzMatch = keyPart.match(/TZID=([^;:]+)/);
                            if (tzMatch) tzid = tzMatch[1];
                        }
                        
                        const isDateOnly = keyPart.includes('VALUE=DATE') && !keyPart.includes('VALUE=DATE-TIME');
                        
                        if (keyPart.startsWith('DTSTART')) {
                            currentEvent.start = parseICalDate(value, tzid || calendarTzid);
                            currentEvent.isAllDay = isDateOnly || value.length === 8;
                        } else if (keyPart.startsWith('DTEND')) {
                            currentEvent.end = parseICalDate(value, tzid || calendarTzid);
                        } else if (keyPart === 'SUMMARY') {
                            currentEvent.summary = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ');
                        } else if (keyPart === 'LOCATION') {
                            currentEvent.location = value.replace(/\\,/g, ',').replace(/\\;/g, ';');
                        }
                    }
                }
            }

            return events;
        }

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function formatDateRange(event) {
            if (!event.start) return '';
            
            const startDate = formatDate(event.start);
            
            if (event.end) {
                const startDay = new Date(event.start.getFullYear(), event.start.getMonth(), event.start.getDate());
                const endDay = new Date(event.end.getFullYear(), event.end.getMonth(), event.end.getDate());
                
                if (event.isAllDay) {
                    endDay.setDate(endDay.getDate() - 1);
                }
                
                const daysDiff = Math.round((endDay - startDay) / (1000 * 60 * 60 * 24));
                
                if (daysDiff >= 1) {
                    const endDateStr = formatDate(endDay);
                    return `${startDate} - ${endDateStr}`;
                }
            }
            
            return startDate;
        }

        function getEventsForMonth(monthIndex) {
            let allEvents = [...events];
            
            if (includeTeam) {
                const teamEventsWithFlag = teamEvents.map(e => ({...e, isTeam: true}));
                allEvents = [...allEvents, ...teamEventsWithFlag];
            }
            
            return allEvents.filter(event => {
                return event.start && event.start.getMonth() === monthIndex;
            }).sort((a, b) => a.start - b.start);
        }

        function groupEventsByDate(events) {
            const grouped = {};
            events.forEach(event => {
                const dateKey = formatDate(event.start);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = [];
                }
                grouped[dateKey].push(event);
            });
            return grouped;
        }

        async function fetchWithProxy(url) {
            const cacheBuster = `nocache=${Date.now()}`;
            const urlWithCache = url + (url.includes('?') ? '&' : '?') + cacheBuster;
            
            const proxies = [
                `https://corsproxy.io/?${encodeURIComponent(urlWithCache)}`,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(urlWithCache)}`,
                `https://proxy.cors.sh/${urlWithCache}`,
            ];
            
            for (const proxyUrl of proxies) {
                try {
                    const response = await fetch(proxyUrl, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (response.ok) {
                        const text = await response.text();
                        if (text.includes('BEGIN:VCALENDAR')) {
                            return text;
                        }
                    }
                } catch (e) {
                    console.log(`Proxy failed: ${proxyUrl}`, e);
                }
            }
            
            throw new Error('Alle Proxies fehlgeschlagen');
        }

        async function fetchWebcal() {
            if (isLoading) return;
            isLoading = true;
            render();

            try {
                const text = await fetchWithProxy(WEBCAL_URL);
                processCalendarData(text);
            } catch (err) {
                console.error('Fehler beim Laden des Webcal Feeds:', err);
            }

            if (TEAM_WEBCAL_URL) {
                try {
                    const teamText = await fetchWithProxy(TEAM_WEBCAL_URL);
                    processTeamCalendarData(teamText);
                } catch (err) {
                    console.error('Fehler beim Laden des Team-Kalenders:', err);
                }
            }

            isLoading = false;
            render();
        }

        function processCalendarData(text) {
            try {
                const allEvents = parseICalendar(text);
                
                const filtered = allEvents.filter(event => {
                    if (!event.start) return false;
                    const eventYear = event.start.getFullYear();
                    return eventYear === parseInt(year);
                });
                
                filtered.sort((a, b) => a.start - b.start);
                
                events = filtered;
                lastUpdated = new Date();
            } catch (err) {
                console.error('Fehler beim Verarbeiten:', err);
            }
        }

        function processTeamCalendarData(text) {
            try {
                const allEvents = parseICalendar(text);
                
                const filtered = allEvents.filter(event => {
                    if (!event.start) return false;
                    const eventYear = event.start.getFullYear();
                    return eventYear === parseInt(year);
                });
                
                filtered.sort((a, b) => a.start - b.start);
                
                teamEvents = filtered;
            } catch (err) {
                console.error('Fehler beim Verarbeiten des Team-Kalenders:', err);
            }
        }

        function renderMonthCell(month, monthIndex) {
            const monthEvents = getEventsForMonth(monthIndex);
            const groupedByDate = groupEventsByDate(monthEvents);
            
            return `
                <td style="width: 16.666%; vertical-align: top; padding: 0;">
                    <div style="border: 2px solid #d4c4b0; border-radius: 8px; padding: 6px; background: rgba(255,255,255,0.5); height: 100%;">
                        <h2 style="font-size: 18px; font-weight: 900; margin: 0 0 6px 0; padding-bottom: 6px; border-bottom: 2px solid #d4c4b0; color: #5a4a3a;">${month}</h2>
                        <div>
                            ${Object.keys(groupedByDate).length === 0 ? 
                                '<p style="font-size: 12px; color: #999; font-style: italic; margin: 0;">Keine Events</p>' :
                                Object.entries(groupedByDate).map(([date, dayEvents], dayIdx) => `
                                    ${dayIdx > 0 ? '<div style="height: 6px;"></div>' : ''}
                                    <div style="background: rgba(212, 196, 176, 0.2); border: 1px solid #d4c4b0; border-radius: 6px; padding: 6px; margin-bottom: 0; font-size: 11px; line-height: 1.5;">
                                        ${dayEvents.map((event, idx) => `
                                            ${idx > 0 ? '<div style="height: 1px; background: #d4c4b0; margin: 6px 0;"></div>' : ''}
                                            <div style="font-weight: bold; text-transform: uppercase; color: ${event.isTeam ? '#cc7c7c' : '#5a4a3a'}; margin: 0;">
                                                ${event.summary}
                                            </div>
                                        `).join('')}
                                        <div style="height: 1px; background: #d4c4b0; margin: 6px 0;"></div>
                                        <div style="font-size: 10px; color: #7a6a5a; margin: 0;">
                                            ${formatDateRange(dayEvents[0])}
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </td>
            `;
        }

        async function downloadAsImage() {
            const element = document.getElementById('calendar-preview');
            if (!element) return;

            try {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/dom-to-image-more@2.8.0/dist/dom-to-image-more.min.js';
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });

                const blob = await window.domtoimage.toBlob(element, {
                    width: 1587,
                    height: 1123,
                    bgcolor: '#f5f1eb',
                    quality: 1,
                    style: {
                        transform: 'scale(1)',
                        transformOrigin: 'top left'
                    }
                });
                
                const link = document.createElement('a');
                link.download = includeTeam ? `youth-revival-events-team-daten-${year}.png` : `youth-revival-events-${year}.png`;
                link.href = URL.createObjectURL(blob);
                link.click();
            } catch (err) {
                alert('Fehler beim Erstellen des Bildes: ' + err.message);
            }
        }

        function switchTab(withTeam) {
            if (withTeam && !teamUnlocked) {
                const password = prompt('Passwort für Teamevents:');
                if (password === TEAM_PASSWORD) {
                    teamUnlocked = true;
                    includeTeam = true;
                    render();
                } else if (password !== null) {
                    alert('Falsches Passwort!');
                }
                return;
            }
            includeTeam = withTeam;
            render();
        }

        function render() {
            const totalEvents = events.length + (includeTeam ? teamEvents.length : 0);
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-4">
                    <div style="width: 1587px; margin: 0 auto;">
                        <!-- Header -->
                        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div class="flex items-center gap-3">
                                    <svg class="w-8 h-8 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    <h1 class="text-2xl font-bold text-gray-800">Youth Revival Kalender ${year}</h1>
                                </div>
                                
                                <div class="flex items-center gap-3">
                                    <!-- Tabs -->
                                    <div class="flex rounded-lg overflow-hidden border border-gray-300">
                                        <button 
                                            onclick="switchTab(false)"
                                            class="${!includeTeam ? 'bg-black text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} px-4 py-2 font-medium transition"
                                        >
                                            Events
                                        </button>
                                        <button 
                                            onclick="switchTab(true)"
                                            class="${includeTeam ? 'bg-black text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} px-4 py-2 font-medium transition flex items-center gap-1"
                                        >
                                            ${!teamUnlocked ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0110 0v4"></path></svg>' : ''}
                                            + Teamevents
                                        </button>
                                    </div>
                                    
                                    <!-- Refresh Button -->
                                    <button 
                                        onclick="fetchWebcal()"
                                        class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}"
                                        title="Kalender neu laden"
                                        ${isLoading ? 'disabled' : ''}
                                    >
                                        <svg class="w-5 h-5 ${isLoading ? 'animate-spin' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                    </button>
                                    
                                    <!-- Download Button -->
                                    ${totalEvents > 0 ? `
                                        <button 
                                            onclick="downloadAsImage()"
                                            class="bg-black hover:bg-gray-800 text-white p-2 rounded-lg transition"
                                            title="Als PNG herunterladen"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                            </svg>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Status Bar -->
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200 text-sm text-gray-500">
                                <span>${totalEvents} Event${totalEvents !== 1 ? 's' : ''} ${includeTeam ? '(inkl. Team)' : ''}</span>
                                <span>${lastUpdated ? `Aktualisiert: ${formatLastUpdated()} • Auto-Refresh alle 30 Min.` : (isLoading ? 'Laden...' : '')}</span>
                            </div>
                        </div>

                        <!-- Calendar Preview -->
                        ${totalEvents > 0 || isLoading ? `
                            <div id="calendar-preview" style="width: 1587px; height: 1123px; background: #f5f1eb; padding: 15px; margin: 0 auto; box-sizing: border-box;">
                                <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 4px solid #d4c4b0; display: flex; align-items: center; justify-content: space-between;">
                                    <h1 style="font-size: 18px; font-weight: 900; color: #5a4a3a; letter-spacing: -0.025em; margin: 0;">
                                        YOUTH REVIVAL EVENTS${includeTeam ? ' + TEAM DATEN' : ''}
                                    </h1>
                                    <div style="font-size: 18px; font-weight: 900; color: #5a4a3a;">${year}</div>
                                </div>

                                <table style="width: 100%; border-collapse: separate; border-spacing: 10px; table-layout: fixed;">
                                    <tbody>
                                        <tr style="height: 48%;">
                                            ${months.slice(0, 6).map((month, idx) => renderMonthCell(month, idx)).join('')}
                                        </tr>
                                        <tr style="height: 48%;">
                                            ${months.slice(6, 12).map((month, idx) => renderMonthCell(month, idx + 6)).join('')}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="bg-white rounded-lg shadow-lg p-12 text-center">
                                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <p class="text-gray-500">Kalender wird geladen...</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Initial render and auto-load
        render();
        fetchWebcal();
    </script>
</body>
</html>