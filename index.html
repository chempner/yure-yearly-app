<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youth Revival Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div id="app"></div>

    <script>
        // Local cached calendar files (served by nginx)
        const CALENDAR_URL = '/data/calendar.ics';
        const TEAM_CALENDAR_URL = '/data/team-calendar.ics';
        const STATUS_URL = '/data/status.json';
        
        const months = [
            'JANUAR', 'FEBRUAR', 'MÄRZ', 'APRIL', 'MAI', 'JUNI',
            'JULI', 'AUGUST', 'SEPTEMBER', 'OKTOBER', 'NOVEMBER', 'DEZEMBER'
        ];

        let year = 2026;
        let allEventsRaw = [];
        let allTeamEventsRaw = [];
        let events = [];
        let teamEvents = [];
        let includeTeam = false;
        let lastUpdated = null;
        let isLoading = false;
        let teamUnlocked = false;
        const TEAM_PASSWORD = 'lordsendrevival';

        function filterEventsByYear() {
            events = allEventsRaw.filter(event => {
                if (!event.start) return false;
                return event.start.getFullYear() === parseInt(year);
            });
            events.sort((a, b) => a.start - b.start);
            
            teamEvents = allTeamEventsRaw.filter(event => {
                if (!event.start) return false;
                return event.start.getFullYear() === parseInt(year);
            });
            teamEvents.sort((a, b) => a.start - b.start);
        }

        function changeYear(newYear) {
            year = newYear;
            filterEventsByYear();
            if (events.length > 0 || teamEvents.length > 0) {
                currentScale = findOptimalScale();
            }
            render();
        }

        // Auto-refresh every 30 minutes (sync with server-side cron)
        setInterval(() => {
            console.log('Auto-refreshing calendar...');
            fetchCalendars();
        }, 30 * 60 * 1000);

        function formatLastUpdated() {
            if (!lastUpdated) return '';
            return lastUpdated.toLocaleString('de-CH', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function parseICalDate(dateStr, tzid = null) {
            if (!dateStr) return null;
            
            if (dateStr.length === 8) {
                const y = parseInt(dateStr.substring(0, 4));
                const m = parseInt(dateStr.substring(4, 6)) - 1;
                const d = parseInt(dateStr.substring(6, 8));
                const date = new Date(y, m, d, 0, 0, 0);
                date.isAllDay = true;
                return date;
            }
            
            if (dateStr.includes('T')) {
                const isUTC = dateStr.endsWith('Z');
                const cleanDate = dateStr.replace('Z', '');
                const y = parseInt(cleanDate.substring(0, 4));
                const m = parseInt(cleanDate.substring(4, 6)) - 1;
                const d = parseInt(cleanDate.substring(6, 8));
                const h = parseInt(cleanDate.substring(9, 11)) || 0;
                const min = parseInt(cleanDate.substring(11, 13)) || 0;
                const s = parseInt(cleanDate.substring(13, 15)) || 0;
                
                if (isUTC) {
                    const utcDate = new Date(Date.UTC(y, m, d, h, min, s));
                    const zurichDate = new Date(utcDate.toLocaleString('en-US', { timeZone: 'Europe/Zurich' }));
                    return zurichDate;
                } else {
                    return new Date(y, m, d, h, min, s);
                }
            }
            
            return new Date(dateStr);
        }

        function parseICalendar(icalData) {
            const events = [];
            const lines = icalData.split(/\r?\n/);
            let currentEvent = null;
            let calendarTzid = 'Europe/Zurich';

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                while (i + 1 < lines.length && (lines[i + 1].startsWith(' ') || lines[i + 1].startsWith('\t'))) {
                    i++;
                    line += lines[i].substring(1);
                }

                if (line.startsWith('X-WR-TIMEZONE:')) {
                    calendarTzid = line.substring(14);
                }

                if (line === 'BEGIN:VEVENT') {
                    currentEvent = { isAllDay: false };
                } else if (line === 'END:VEVENT' && currentEvent) {
                    events.push(currentEvent);
                    currentEvent = null;
                } else if (currentEvent) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const keyPart = line.substring(0, colonIndex);
                        const value = line.substring(colonIndex + 1);
                        
                        let tzid = null;
                        if (keyPart.includes('TZID=')) {
                            const tzMatch = keyPart.match(/TZID=([^;:]+)/);
                            if (tzMatch) tzid = tzMatch[1];
                        }
                        
                        const isDateOnly = keyPart.includes('VALUE=DATE') && !keyPart.includes('VALUE=DATE-TIME');
                        
                        if (keyPart.startsWith('DTSTART')) {
                            currentEvent.start = parseICalDate(value, tzid || calendarTzid);
                            currentEvent.isAllDay = isDateOnly || value.length === 8;
                        } else if (keyPart.startsWith('DTEND')) {
                            currentEvent.end = parseICalDate(value, tzid || calendarTzid);
                        } else if (keyPart === 'SUMMARY') {
                            currentEvent.summary = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ');
                        } else if (keyPart === 'LOCATION') {
                            currentEvent.location = value.replace(/\\,/g, ',').replace(/\\;/g, ';');
                        }
                    }
                }
            }

            return events;
        }

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function formatDateRange(event) {
            if (!event.start) return '';
            
            const startDate = formatDate(event.start);
            
            if (event.end) {
                const startDay = new Date(event.start.getFullYear(), event.start.getMonth(), event.start.getDate());
                const endDay = new Date(event.end.getFullYear(), event.end.getMonth(), event.end.getDate());
                
                if (event.isAllDay) {
                    endDay.setDate(endDay.getDate() - 1);
                }
                
                const daysDiff = Math.round((endDay - startDay) / (1000 * 60 * 60 * 24));
                
                if (daysDiff >= 1) {
                    const endDateStr = formatDate(endDay);
                    return `${startDate} - ${endDateStr}`;
                }
            }
            
            return startDate;
        }

        function getEventsForMonth(monthIndex) {
            let allEvents = [...events];
            
            if (includeTeam) {
                const teamEventsWithFlag = teamEvents.map(e => ({...e, isTeam: true}));
                allEvents = [...allEvents, ...teamEventsWithFlag];
            }
            
            return allEvents.filter(event => {
                return event.start && event.start.getMonth() === monthIndex;
            }).sort((a, b) => a.start - b.start);
        }

        function groupEventsByDate(events) {
            const grouped = {};
            events.forEach(event => {
                const dateKey = formatDate(event.start);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = [];
                }
                grouped[dateKey].push(event);
            });
            return grouped;
        }

        async function fetchCalendars() {
            if (isLoading) return;
            isLoading = true;
            render();

            try {
                // Trigger server-side refresh first and wait for it
                const refreshResponse = await fetch('/cgi-bin/refresh.cgi?t=' + Date.now());
                if (refreshResponse.ok) {
                    const status = await refreshResponse.json();
                    if (status && status.lastUpdated) {
                        lastUpdated = new Date(status.lastUpdated);
                    }
                }
            } catch (err) {
                console.log('Server refresh nicht verfügbar, lade aus Cache...', err);
            }

            try {
                // Fetch main calendar from local cache
                const response = await fetch(CALENDAR_URL + '?t=' + Date.now());
                if (response.ok) {
                    const text = await response.text();
                    allEventsRaw = parseICalendar(text);
                }
            } catch (err) {
                console.error('Fehler beim Laden des Kalenders:', err);
            }

            try {
                // Fetch team calendar from local cache
                const teamResponse = await fetch(TEAM_CALENDAR_URL + '?t=' + Date.now());
                if (teamResponse.ok) {
                    const teamText = await teamResponse.text();
                    allTeamEventsRaw = parseICalendar(teamText);
                }
            } catch (err) {
                console.error('Fehler beim Laden des Team-Kalenders:', err);
            }

            // If we didn't get lastUpdated from CGI, try status.json
            if (!lastUpdated) {
                try {
                    const statusResponse = await fetch(STATUS_URL + '?t=' + Date.now());
                    if (statusResponse.ok) {
                        const status = await statusResponse.json();
                        lastUpdated = new Date(status.lastUpdated);
                    }
                } catch (err) {
                    lastUpdated = new Date();
                }
            }

            filterEventsByYear();
            
            // Calculate optimal scale based on content
            if (events.length > 0 || teamEvents.length > 0) {
                currentScale = findOptimalScale();
            }
            
            isLoading = false;
            render();
        }

        function renderMonthCell(month, monthIndex, scale = 1) {
            const monthEvents = getEventsForMonth(monthIndex);
            const groupedByDate = groupEventsByDate(monthEvents);
            
            // Fixed sizes that work at scale 1.0
            const titleSize = 18;
            const eventSize = 11;
            const dateSize = 10;
            const padding = 6;
            const gap = 6;
            const radius = 6;
            
            return `
                <td style="width: 16.666%; vertical-align: top; padding: 0; height: 100%;">
                    <div class="month-cell" style="border: 2px solid #d4c4b0; border-radius: 8px; padding: ${padding}px; background: rgba(255,255,255,0.5); height: 100%; box-sizing: border-box; overflow: hidden;">
                        <h2 style="font-size: ${titleSize}px; font-weight: 900; margin: 0 0 ${padding}px 0; padding-bottom: ${padding}px; border-bottom: 2px solid #d4c4b0; color: #5a4a3a;">${month}</h2>
                        <div class="month-content">
                            ${Object.keys(groupedByDate).length === 0 ? 
                                `<p style="font-size: ${eventSize}px; color: #999; font-style: italic; margin: 0;">Keine Events</p>` :
                                Object.entries(groupedByDate).map(([date, dayEvents], dayIdx) => `
                                    ${dayIdx > 0 ? `<div style="height: ${gap}px;"></div>` : ''}
                                    <div style="background: rgba(212, 196, 176, 0.2); border: 1px solid #d4c4b0; border-radius: ${radius}px; padding: ${padding}px; margin-bottom: 0; font-size: ${eventSize}px; line-height: 1.4;">
                                        ${dayEvents.map((event, idx) => `
                                            ${idx > 0 ? `<div style="height: 1px; background: #d4c4b0; margin: ${padding}px 0;"></div>` : ''}
                                            <div style="font-weight: bold; text-transform: uppercase; color: ${event.isTeam ? '#cc7c7c' : '#5a4a3a'}; margin: 0;">
                                                ${event.summary}
                                            </div>
                                        `).join('')}
                                        <div style="height: 1px; background: #d4c4b0; margin: ${padding}px 0;"></div>
                                        <div style="font-size: ${dateSize}px; color: #7a6a5a; margin: 0;">
                                            ${formatDateRange(dayEvents[0])}
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </td>
            `;
        }

        let currentScale = 1.0;

        function renderCalendarWithScale(scale) {
            return `
                <div id="calendar-preview" style="width: 1587px; height: 1123px; background: #f5f1eb; padding: 15px; margin: 0 auto; box-sizing: border-box; overflow: hidden;">
                    <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 4px solid #d4c4b0; display: flex; align-items: center; justify-content: space-between;">
                        <h1 style="font-size: 18px; font-weight: 900; color: #5a4a3a; letter-spacing: -0.025em; margin: 0;">
                            YOUTH REVIVAL EVENTS${includeTeam ? ' + TEAM DATEN' : ''}
                        </h1>
                        <div style="font-size: 18px; font-weight: 900; color: #5a4a3a;">${year}</div>
                    </div>

                    <table style="width: 100%; height: calc(100% - 50px); border-collapse: separate; border-spacing: 10px; table-layout: fixed;">
                        <tbody>
                            <tr style="height: 50%;">
                                ${months.slice(0, 6).map((month, idx) => renderMonthCell(month, idx, scale)).join('')}
                            </tr>
                            <tr style="height: 50%;">
                                ${months.slice(6, 12).map((month, idx) => renderMonthCell(month, idx + 6, scale)).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function findOptimalScale() {
            // For now, just return 1.0 - scaling is disabled until we fix overflow issues
            return 1.0;
        }

        async function downloadAsImage() {
            const element = document.getElementById('calendar-preview');
            if (!element) return;

            try {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/dom-to-image-more@2.8.0/dist/dom-to-image-more.min.js';
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });

                const blob = await window.domtoimage.toBlob(element, {
                    width: 1587,
                    height: 1123,
                    bgcolor: '#f5f1eb',
                    quality: 1,
                    style: {
                        transform: 'scale(1)',
                        transformOrigin: 'top left'
                    }
                });
                
                const link = document.createElement('a');
                link.download = includeTeam ? `youth-revival-events-team-daten-${year}.png` : `youth-revival-events-${year}.png`;
                link.href = URL.createObjectURL(blob);
                link.click();
            } catch (err) {
                alert('Fehler beim Erstellen des Bildes: ' + err.message);
            }
        }

        function switchTab(withTeam) {
            if (withTeam && !teamUnlocked) {
                const password = prompt('Passwort für Teamevents:');
                if (password === TEAM_PASSWORD) {
                    teamUnlocked = true;
                    includeTeam = true;
                    currentScale = findOptimalScale();
                    render();
                } else if (password !== null) {
                    alert('Falsches Passwort!');
                }
                return;
            }
            includeTeam = withTeam;
            currentScale = findOptimalScale();
            render();
        }

        function render() {
            const totalEvents = events.length + (includeTeam ? teamEvents.length : 0);
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-4">
                    <div style="width: 1587px; margin: 0 auto;">
                        <!-- Header -->
                        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div class="flex items-center gap-3">
                                    <svg class="w-8 h-8 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    <h1 class="text-2xl font-bold text-gray-800">Youth Revival Kalender</h1>
                                    <div class="relative">
                                        <select 
                                            onchange="changeYear(parseInt(this.value))"
                                            class="appearance-none text-2xl font-bold text-white bg-black hover:bg-gray-800 pl-4 pr-10 py-1 rounded-lg cursor-pointer outline-none transition"
                                            style="max-height: 300px;"
                                        >
                                            ${Array.from({length: 2040 - 2020 + 1}, (_, i) => 2020 + i).map(y => `
                                                <option value="${y}" ${y === year ? 'selected' : ''} class="text-black bg-white">${y}</option>
                                            `).join('')}
                                        </select>
                                        <svg class="w-5 h-5 absolute right-2 top-1/2 -translate-y-1/2 text-white pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-3">
                                    <!-- Tabs -->
                                    <div class="flex rounded-lg overflow-hidden border border-gray-300">
                                        <button 
                                            onclick="switchTab(false)"
                                            class="${!includeTeam ? 'bg-black text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} px-4 py-2 font-medium transition"
                                        >
                                            Events
                                        </button>
                                        <button 
                                            onclick="switchTab(true)"
                                            class="${includeTeam ? 'bg-black text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} px-4 py-2 font-medium transition flex items-center gap-1"
                                        >
                                            ${!teamUnlocked ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0110 0v4"></path></svg>' : ''}
                                            + Teamevents
                                        </button>
                                    </div>
                                    
                                    <!-- Refresh Button -->
                                    <button 
                                        onclick="fetchCalendars()"
                                        class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}"
                                        title="Kalender neu laden"
                                        ${isLoading ? 'disabled' : ''}
                                    >
                                        <svg class="w-5 h-5 ${isLoading ? 'animate-spin' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                    </button>
                                    
                                    <!-- Download Button -->
                                    ${totalEvents > 0 ? `
                                        <button 
                                            onclick="downloadAsImage()"
                                            class="bg-black hover:bg-gray-800 text-white p-2 rounded-lg transition"
                                            title="Als PNG herunterladen"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                            </svg>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Status Bar -->
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200 text-sm text-gray-500">
                                <span>${totalEvents} Event${totalEvents !== 1 ? 's' : ''} ${includeTeam ? '(inkl. Team)' : ''}</span>
                                <span>${lastUpdated ? `Server-Cache: ${formatLastUpdated()} • Auto-Refresh alle 30 Min.` : (isLoading ? 'Laden...' : '')}</span>
                            </div>
                        </div>

                        <!-- Calendar Preview -->
                        ${totalEvents > 0 || isLoading ? renderCalendarWithScale(currentScale) : `
                            <div class="bg-white rounded-lg shadow-lg p-12 text-center">
                                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <p class="text-gray-500">Kalender wird geladen...</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Initial render and auto-load
        render();
        fetchCalendars();
    </script>
</body>
</html>
